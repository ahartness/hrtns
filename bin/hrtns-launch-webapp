#!/bin/bash

if [[ -n "$WEBAPP_BROWSER" ]]; then
  browser="$WEBAPP_BROWSER"
else
  # List of browsers to try, in order of preference
  browsers=(
    "helium-browser"
    "chromium"
    "brave-browser"
    "google-chrome"
    "microsoft-edge"
    "vivaldi"
    "opera"
  )

  # Find first installed browser
  for b in "${browsers[@]}"; do
    for dir in ~/.local/share/applications /usr/share/applications; do
      if [[ -f "$dir/$b.desktop" ]] || [[ -f "$dir/$b" ]]; then
        browser="$b"
        break 2
      fi
    done
  done

  # If no browser found, exit with error
  if [[ -z "$browser" ]]; then
    echo "Error: No supported browser found" >&2
    echo "Install one of: ${browsers[*]}" >&2
    exit 1
  fi
fi

# Ensure .desktop extension if needed
case $browser in
google-chrome* | brave-browser* | microsoft-edge* | opera* | vivaldi*) ;;
*) browser="$browser.desktop" ;;
esac

exec setsid uwsm app -- $(sed -n 's/^Exec=\([^ ]*\).*/\1/p' {~/.local,/usr}/share/applications/$browser 2>/dev/null | head -1) --app="$1" "${@:2}"
